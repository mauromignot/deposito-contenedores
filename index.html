<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dep√≥sito de Contenedores</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Barlow:wght@400;600;700&display=swap');
 
  :root {
    --bg: #1a1d1f;
    --surface: #22262a;
    --surface2: #2c3136;
    --border: #3a4048;
    --accent: #f5a623;
    --danger: #e74c3c;
    --text: #d4dbe3;
    --text-dim: #6b7a8d;
    --c20: #2ecc71;
    --c40: #3498db;
    --cell-size: 48px;
    --grid-cols: 20;
    --grid-rows: 12;
  }
 
  * { margin: 0; padding: 0; box-sizing: border-box; }
 
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
 
  header {
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
 
  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 3px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(245,166,35,0.3);
  }
 
  .logo span { color: var(--text-dim); font-size: 14px; display: block; font-family: 'Share Tech Mono', monospace; letter-spacing: 2px; margin-top: -4px; }
 
  .stats { display: flex; gap: 16px; margin-left: auto; flex-wrap: wrap; align-items: center; }
 
  .stat {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
  }
 
  .stat .val { color: var(--accent); font-size: 18px; display: block; text-align: center; }
  .stat .lbl { color: var(--text-dim); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
 
  /* Save status indicator */
  .save-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 5px 10px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
 
  .save-status.saved { color: var(--c20); }
  .save-status.saving { color: var(--accent); }
  .save-status.error { color: var(--danger); }
 
  .save-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: currentColor;
  }
 
  .save-status.saving .save-dot { animation: pulse 0.8s infinite; }
 
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
 
  .app { display: flex; height: calc(100vh - 70px); }
 
  .sidebar {
    width: 220px;
    min-width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
  }
 
  .sidebar h3 {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }
 
  .container-card {
    border-radius: 8px;
    padding: 12px;
    cursor: grab;
    user-select: none;
    border: 2px solid transparent;
    transition: all 0.15s;
  }
 
  .container-card:active { cursor: grabbing; transform: scale(0.97); }
  .container-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
  .container-card.c20 { background: linear-gradient(135deg, #1a4a2e, #0d2b1a); border-color: var(--c20); }
  .container-card.c40 { background: linear-gradient(135deg, #0d2b4a, #071a2e); border-color: var(--c40); }
  .container-card .size-badge { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 2px; line-height: 1; }
  .c20 .size-badge { color: var(--c20); }
  .c40 .size-badge { color: var(--c40); }
  .container-card .desc { font-size: 11px; color: var(--text-dim); margin-top: 4px; font-family: 'Share Tech Mono', monospace; }
  .container-card .dims { font-size: 10px; color: var(--text-dim); margin-top: 6px; background: rgba(0,0,0,0.2); padding: 3px 6px; border-radius: 3px; font-family: 'Share Tech Mono', monospace; }
 
  .drag-hint { font-size: 10px; color: var(--text-dim); text-align: center; opacity: 0.6; }
 
  .orient-btns { display: flex; gap: 6px; }
 
  .orient-btn {
    flex: 1; padding: 7px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text-dim);
    font-size: 11px;
    cursor: pointer;
    font-family: 'Share Tech Mono', monospace;
    transition: all 0.15s;
    text-align: center;
  }
 
  .orient-btn.active, .orient-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }
 
  .color-row { display: flex; gap: 6px; flex-wrap: wrap; }
 
  .color-dot {
    width: 22px; height: 22px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.15s;
  }
 
  .color-dot:hover, .color-dot.active { transform: scale(1.3); border-color: #fff; }
 
  .btn {
    width: 100%; padding: 9px;
    border: none; border-radius: 6px;
    cursor: pointer;
    font-family: 'Barlow', sans-serif;
    font-weight: 700; font-size: 13px;
    letter-spacing: 1px; text-transform: uppercase;
    transition: all 0.15s;
  }
 
  .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
  .btn-danger:hover { background: var(--danger); color: #fff; }
  .btn-accent { background: var(--accent); color: #000; }
  .btn-accent:hover { background: #e09400; }
 
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
 
  .toolbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 8px 16px;
    display: flex; align-items: center; gap: 12px;
    font-size: 12px; color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
  }
 
  .toolbar .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--c20);
    animation: pulse 1.5s infinite;
  }
 
  .grid-wrap {
    flex: 1; overflow: auto; padding: 20px;
    background: var(--bg);
    background-image: radial-gradient(circle at 50% 50%, rgba(245,166,35,0.03) 0%, transparent 60%);
  }
 
  .yard-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px; letter-spacing: 3px;
    color: var(--text-dim); margin-bottom: 8px;
    display: flex; align-items: center; gap: 8px;
  }
 
  .yard-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
 
  .grid-container { display: flex; }
 
  .row-labels {
    display: flex; flex-direction: column;
    margin-top: calc(var(--cell-size) + 4px);
  }
 
  .row-label {
    height: var(--cell-size); width: 28px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px; color: var(--text-dim);
  }
 
  .col-labels { display: flex; margin-bottom: 4px; margin-left: 28px; }
 
  .col-label {
    width: var(--cell-size); height: 20px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px; color: var(--text-dim);
  }
 
  .grid {
    display: grid;
    grid-template-columns: repeat(var(--grid-cols), var(--cell-size));
    grid-template-rows: repeat(var(--grid-rows), var(--cell-size));
    border: 1px solid var(--border);
    background: var(--surface);
    position: relative;
  }
 
  .cell {
    width: var(--cell-size); height: var(--cell-size);
    border: 1px solid rgba(58,64,72,0.5);
    position: relative; transition: background 0.1s;
  }
 
  .cell.highlight { background: rgba(245,166,35,0.1); border-color: var(--accent); }
  .cell.invalid { background: rgba(231,76,60,0.15); border-color: var(--danger); }
 
  .container-piece {
    position: absolute; border-radius: 4px;
    cursor: grab; user-select: none;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px; letter-spacing: 1px;
    border: 2px solid;
    transition: box-shadow 0.15s, transform 0.1s;
    z-index: 10; overflow: hidden;
    flex-direction: column; gap: 1px;
  }
 
  .container-piece::before {
    content: ''; position: absolute;
    top: 0; left: 0; right: 0; height: 3px;
    background: rgba(255,255,255,0.2);
  }
 
  .container-piece:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 20; }
  .container-piece:active { cursor: grabbing; transform: scale(1.03); z-index: 30; }
  .container-piece.selected { box-shadow: 0 0 0 2px #fff, 0 4px 20px rgba(0,0,0,0.5); z-index: 25; }
  .container-piece .piece-id { font-size: 11px; opacity: 0.9; line-height: 1; }
  .container-piece .piece-size { font-size: 9px; opacity: 0.6; font-family: 'Share Tech Mono', monospace; }
 
  .info-panel {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 8px 16px;
    display: flex; align-items: center; gap: 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px; color: var(--text-dim);
    min-height: 36px;
  }
 
  .info-panel .selected-info { color: var(--accent); }
  .info-panel .hint { margin-left: auto; opacity: 0.5; }
 
  .delete-zone {
    border: 1px dashed var(--danger);
    border-radius: 6px; padding: 10px;
    text-align: center; font-size: 11px;
    color: var(--danger);
    font-family: 'Share Tech Mono', monospace;
    transition: all 0.15s; cursor: pointer;
  }
 
  .delete-zone:hover, .delete-zone.drag-over { background: rgba(231,76,60,0.1); }
  .delete-zone .icon { font-size: 20px; display: block; margin-bottom: 4px; }
 
  .legend { display: flex; gap: 12px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-dim); font-family: 'Share Tech Mono', monospace; }
  .legend-box { width: 14px; height: 14px; border-radius: 2px; border: 1px solid; }
 
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); z-index: 100;
    align-items: center; justify-content: center;
  }
 
  .modal-overlay.show { display: flex; }
 
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 24px; width: 320px;
    border-top: 3px solid var(--accent);
  }
 
  .modal h3 { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; margin-bottom: 16px; color: var(--accent); }
 
  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 11px; color: var(--text-dim); font-family: 'Share Tech Mono', monospace; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .form-group input, .form-group select { width: 100%; padding: 9px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Share Tech Mono', monospace; font-size: 13px; }
  .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
 
  .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
  .modal-btns .btn { flex: 1; }
  .btn-cancel { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); }
  .btn-cancel:hover { border-color: var(--text); color: var(--text); }
 
  /* Loading overlay */
  .loading-overlay {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 200; gap: 16px;
  }
 
  .loading-overlay .loading-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px; letter-spacing: 4px;
    color: var(--accent);
  }
 
  .loading-overlay .loading-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px; color: var(--text-dim);
    letter-spacing: 2px;
  }
 
  .loading-bar {
    width: 200px; height: 3px;
    background: var(--border); border-radius: 2px; overflow: hidden;
  }
 
  .loading-bar-inner {
    height: 100%; width: 40%;
    background: var(--accent); border-radius: 2px;
    animation: loading 1s infinite;
  }
 
  @keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(350%); }
  }
 
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
 
<!-- Loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">YARD</div>
  <div class="loading-bar"><div class="loading-bar-inner"></div></div>
  <div class="loading-sub">CONECTANDO CON FIREBASE...</div>
</div>
 
<header>
  <div class="logo">YARD<br><span>CONTAINER LAYOUT v2.0 ‚Äî FIREBASE</span></div>
  <div class="stats">
    <div class="stat"><span class="val" id="stat-total">0</span><span class="lbl">Total</span></div>
    <div class="stat"><span class="val" id="stat-20" style="color:var(--c20)">0</span><span class="lbl">√ó 20 pies</span></div>
    <div class="stat"><span class="val" id="stat-40" style="color:var(--c40)">0</span><span class="lbl">√ó 40 pies</span></div>
    <div class="stat"><span class="val" id="stat-teu">0</span><span class="lbl">TEUs</span></div>
    <div class="save-status saved" id="saveStatus">
      <div class="save-dot"></div>
      <span id="saveText">Guardado</span>
    </div>
  </div>
</header>
 
<div class="app">
  <div class="sidebar">
    <h3>// Agregar</h3>
    <div class="container-card c20" draggable="true" data-type="20" id="card20">
      <div class="size-badge">20'</div>
      <div class="desc">CONTENEDOR EST√ÅNDAR</div>
      <div class="dims">6.1m √ó 2.44m √ó 2.59m</div>
    </div>
    <div class="container-card c40" draggable="true" data-type="40" id="card40">
      <div class="size-badge">40'</div>
      <div class="desc">CONTENEDOR LARGO</div>
      <div class="dims">12.2m √ó 2.44m √ó 2.59m</div>
    </div>
    <div class="drag-hint">‚Üë Arrastr√° al patio o hac√© clic</div>
 
    <h3>// Orientaci√≥n</h3>
    <div class="orient-btns">
      <div class="orient-btn active" data-orient="H" onclick="setOrientation('H')">‚îÅ Horiz</div>
      <div class="orient-btn" data-orient="V" onclick="setOrientation('V')">‚îÉ Vert</div>
    </div>
 
    <h3>// Color</h3>
    <div class="color-row">
      <div class="color-dot active" style="background:#2ecc71" data-color="#2ecc71" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#3498db" data-color="#3498db" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#e74c3c" data-color="#e74c3c" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#f5a623" data-color="#f5a623" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#9b59b6" data-color="#9b59b6" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#e67e22" data-color="#e67e22" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#1abc9c" data-color="#1abc9c" onclick="setColor(this)"></div>
      <div class="color-dot" style="background:#e91e63" data-color="#e91e63" onclick="setColor(this)"></div>
    </div>
 
    <h3>// Acciones</h3>
    <button class="btn btn-accent" onclick="openModal()">+ Nuevo con etiqueta</button>
 
    <div class="delete-zone" id="deleteZone">
      <span class="icon">üóë</span>
      Solt√° aqu√≠ para eliminar
    </div>
 
    <h3>// Referencia</h3>
    <div class="legend">
      <div class="legend-item"><div class="legend-box" style="background:#1a4a2e;border-color:#2ecc71"></div> 20 pies</div>
      <div class="legend-item"><div class="legend-box" style="background:#0d2b4a;border-color:#3498db"></div> 40 pies</div>
    </div>
 
    <button class="btn btn-danger" onclick="clearAll()">Limpiar todo</button>
  </div>
 
  <div class="main">
    <div class="toolbar">
      <div style="display:flex;align-items:center;gap:6px"><div class="dot"></div>PATIO ACTIVO</div>
      <span>‚îÇ</span>
      <span>GRILLA: <span style="color:var(--text)">20 √ó 12</span></span>
      <span>‚îÇ</span>
      <span id="connectedUsers" style="color:var(--c20)">‚óè CONECTADO</span>
    </div>
    <div class="grid-wrap">
      <div class="yard-label">PATIO DE CONTENEDORES ‚Äî SECTOR A</div>
      <div class="col-labels" id="colLabels"></div>
      <div class="grid-container">
        <div class="row-labels" id="rowLabels"></div>
        <div class="grid" id="grid"></div>
      </div>
    </div>
    <div class="info-panel">
      <span id="infoSelected" class="selected-info"></span>
      <span id="infoPos"></span>
      <span class="hint">DRAG para mover ‚Ä¢ CLIC para seleccionar ‚Ä¢ R para rotar ‚Ä¢ DEL para eliminar</span>
    </div>
  </div>
</div>
 
<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>Nuevo Contenedor</h3>
    <div class="form-group">
      <label>Tama√±o</label>
      <select id="modalSize">
        <option value="20">20 pies (1 TEU)</option>
        <option value="40">40 pies (2 TEU)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Etiqueta / ID</label>
      <input type="text" id="modalLabel" placeholder="Ej: MSCU-123456" maxlength="12">
    </div>
    <div class="form-group">
      <label>Orientaci√≥n</label>
      <select id="modalOrient">
        <option value="H">Horizontal</option>
        <option value="V">Vertical</option>
      </select>
    </div>
    <div class="modal-btns">
      <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-accent" onclick="addFromModal()">Agregar</button>
    </div>
  </div>
</div>
 
<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
 
  const firebaseConfig = {
    apiKey: "AIzaSyDV9gmkpvATFeC0sKNi6YS3YiTT-9DRA0I",
    authDomain: "deposito-contenedores-684fe.firebaseapp.com",
    projectId: "deposito-contenedores-684fe",
    storageBucket: "deposito-contenedores-684fe.firebasestorage.app",
    messagingSenderId: "1045884536319",
    appId: "1:1045884536319:web:93c52a4cd473c809bfd3ca"
  };
 
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const yardDoc = doc(db, "yard", "layout");
 
  // ‚îÄ‚îÄ APP STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const COLS = 20, ROWS = 12, CELL = 48;
  let orientation = 'H';
  let selectedColor = '#2ecc71';
  let containers = [];
  let selectedId = null;
  let dragType = null;
  let dragContainer = null;
  let pendingType = '20';
  let counter = 0;
  let saveTimeout = null;
  let isRemoteUpdate = false;
 
  const grid = document.getElementById('grid');
  const colLabels = document.getElementById('colLabels');
  const rowLabels = document.getElementById('rowLabels');
 
  // ‚îÄ‚îÄ BUILD GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildGrid() {
    for (let c = 1; c <= COLS; c++) {
      const lbl = document.createElement('div');
      lbl.className = 'col-label';
      lbl.textContent = c;
      colLabels.appendChild(lbl);
    }
    for (let r = 1; r <= ROWS; r++) {
      const lbl = document.createElement('div');
      lbl.className = 'row-label';
      lbl.textContent = String.fromCharCode(64 + r);
      rowLabels.appendChild(lbl);
    }
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.r = r;
        cell.dataset.c = c;
        cell.addEventListener('dragover', onCellDragOver);
        cell.addEventListener('dragleave', () => {});
        cell.addEventListener('drop', onCellDrop);
        cell.addEventListener('click', onCellClick);
        grid.appendChild(cell);
      }
    }
  }
 
  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function containerSize(type, orient) {
    if (type === '20') return orient === 'H' ? {w:2,h:1} : {w:1,h:2};
    return orient === 'H' ? {w:4,h:1} : {w:1,h:4};
  }
 
  function canPlace(col, row, w, h, excludeId=null) {
    if (col+w > COLS || row+h > ROWS) return false;
    for (const c of containers) {
      if (c.id === excludeId) continue;
      const cs = containerSize(c.type, c.orient);
      if (col < c.col+cs.w && col+w > c.col && row < c.row+cs.h && row+h > c.row) return false;
    }
    return true;
  }
 
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
 
  function clearHighlights() {
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('highlight','invalid'));
  }
 
  function highlightCells(col, row, w, h, valid) {
    clearHighlights();
    for (let r = row; r < row+h && r < ROWS; r++) {
      for (let c = col; c < col+w && c < COLS; c++) {
        const cell = grid.querySelector(`[data-r="${r}"][data-c="${c}"]`);
        if (cell) cell.classList.add(valid ? 'highlight' : 'invalid');
      }
    }
  }
 
  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function createPiece(container) {
    const cs = containerSize(container.type, container.orient);
    const el = document.createElement('div');
    el.className = 'container-piece';
    el.id = 'piece-'+container.id;
    el.style.left = (container.col * CELL) + 'px';
    el.style.top = (container.row * CELL) + 'px';
    el.style.width = (cs.w * CELL - 2) + 'px';
    el.style.height = (cs.h * CELL - 2) + 'px';
    const col = container.color || (container.type === '20' ? '#2ecc71' : '#3498db');
    el.style.background = hexToRgba(col, 0.18);
    el.style.borderColor = col;
    el.style.color = col;
    el.style.boxShadow = `inset 0 0 20px ${hexToRgba(col,0.08)}`;
    el.innerHTML = `<div class="piece-id">${container.label}</div><div class="piece-size">${container.type}'</div>`;
    el.draggable = true;
    el.dataset.id = container.id;
    el.addEventListener('click', (e) => { e.stopPropagation(); selectContainer(container.id); });
    el.addEventListener('dragstart', (e) => {
      dragType = 'move'; dragContainer = container; selectedId = container.id;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', container.id);
      setTimeout(() => { el.style.opacity = '0.3'; }, 0);
    });
    el.addEventListener('dragend', () => { el.style.opacity = '1'; clearHighlights(); });
    return el;
  }
 
  function renderAll() {
    document.querySelectorAll('.container-piece').forEach(e => e.remove());
    for (const c of containers) grid.appendChild(createPiece(c));
    updateStats();
    if (selectedId) {
      const el = document.getElementById('piece-'+selectedId);
      if (el) el.classList.add('selected');
    }
  }
 
  function updateStats() {
    const t20 = containers.filter(c => c.type === '20').length;
    const t40 = containers.filter(c => c.type === '40').length;
    document.getElementById('stat-20').textContent = t20;
    document.getElementById('stat-40').textContent = t40;
    document.getElementById('stat-total').textContent = t20 + t40;
    document.getElementById('stat-teu').textContent = t20 + t40*2;
  }
 
  function selectContainer(id) {
    selectedId = id;
    document.querySelectorAll('.container-piece').forEach(el => el.classList.toggle('selected', el.dataset.id == id));
    const c = containers.find(x => x.id == id);
    if (c) document.getElementById('infoSelected').textContent = `‚ñ∂ ${c.label} ‚Äî ${c.type}' ‚Äî ${c.orient === 'H' ? 'Horizontal' : 'Vertical'}`;
  }
 
  // ‚îÄ‚îÄ FIREBASE SAVE/LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setSaveStatus(status, text) {
    const el = document.getElementById('saveStatus');
    el.className = 'save-status ' + status;
    document.getElementById('saveText').textContent = text;
  }
 
  async function saveToFirebase() {
    setSaveStatus('saving', 'Guardando...');
    try {
      await setDoc(yardDoc, { containers, counter, updatedAt: Date.now() });
      setSaveStatus('saved', 'Guardado ‚úì');
    } catch (e) {
      setSaveStatus('error', 'Error al guardar');
      console.error(e);
    }
  }
 
  function scheduleSave() {
    if (isRemoteUpdate) return;
    setSaveStatus('saving', 'Guardando...');
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveToFirebase, 800);
  }
 
  // Listen for real-time changes from Firebase
  onSnapshot(yardDoc, (snapshot) => {
    if (snapshot.exists()) {
      const data = snapshot.data();
      isRemoteUpdate = true;
      containers = data.containers || [];
      counter = data.counter || 0;
      renderAll();
      setSaveStatus('saved', 'Guardado ‚úì');
      isRemoteUpdate = false;
    }
    document.getElementById('loadingOverlay').style.display = 'none';
  }, (error) => {
    console.error(error);
    setSaveStatus('error', 'Sin conexi√≥n');
    document.getElementById('loadingOverlay').style.display = 'none';
  });
 
  // ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addContainer(type, col, row, orient, color, label) {
    counter++;
    const lbl = label || (type === '20' ? `C${counter}` : `L${counter}`);
    containers.push({ id: counter, type, col, row, orient, color, label: lbl });
    renderAll();
    scheduleSave();
  }
 
  function quickAdd(type) {
    const cs = containerSize(type, orientation);
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        if (canPlace(c, r, cs.w, cs.h)) { addContainer(type, c, r, orientation, selectedColor); return; }
      }
    }
  }
 
  // ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('card20').addEventListener('dragstart', (e) => { dragType = 'new'; dragContainer = null; pendingType = '20'; e.dataTransfer.effectAllowed = 'copy'; });
  document.getElementById('card40').addEventListener('dragstart', (e) => { dragType = 'new'; dragContainer = null; pendingType = '40'; e.dataTransfer.effectAllowed = 'copy'; });
  document.getElementById('card20').addEventListener('click', () => quickAdd('20'));
  document.getElementById('card40').addEventListener('click', () => quickAdd('40'));
 
  function onCellDragOver(e) {
    e.preventDefault();
    const cell = e.currentTarget;
    const col = parseInt(cell.dataset.c), row = parseInt(cell.dataset.r);
    const type = dragContainer ? dragContainer.type : pendingType;
    const orient = dragContainer ? dragContainer.orient : orientation;
    const cs = containerSize(type, orient);
    const valid = canPlace(col, row, cs.w, cs.h, dragContainer ? dragContainer.id : null);
    highlightCells(col, row, cs.w, cs.h, valid);
    document.getElementById('infoPos').textContent = `Col ${col+1} / Fila ${String.fromCharCode(65+row)}`;
  }
 
  function onCellDrop(e) {
    e.preventDefault();
    const cell = e.currentTarget;
    const col = parseInt(cell.dataset.c), row = parseInt(cell.dataset.r);
    clearHighlights();
    if (dragType === 'new') {
      const cs = containerSize(pendingType, orientation);
      if (canPlace(col, row, cs.w, cs.h)) addContainer(pendingType, col, row, orientation, selectedColor);
    } else if (dragType === 'move' && dragContainer) {
      const cs = containerSize(dragContainer.type, dragContainer.orient);
      if (canPlace(col, row, cs.w, cs.h, dragContainer.id)) {
        dragContainer.col = col; dragContainer.row = row;
        renderAll(); scheduleSave();
      }
    }
    dragType = null; dragContainer = null;
  }
 
  function onCellClick() {
    selectedId = null;
    document.querySelectorAll('.container-piece').forEach(el => el.classList.remove('selected'));
    document.getElementById('infoSelected').textContent = '';
  }
 
  // Delete zone
  const deleteZone = document.getElementById('deleteZone');
  deleteZone.addEventListener('dragover', (e) => { e.preventDefault(); deleteZone.classList.add('drag-over'); });
  deleteZone.addEventListener('dragleave', () => deleteZone.classList.remove('drag-over'));
  deleteZone.addEventListener('drop', (e) => {
    e.preventDefault(); deleteZone.classList.remove('drag-over');
    if (dragContainer) { containers = containers.filter(c => c.id !== dragContainer.id); dragContainer = null; dragType = null; selectedId = null; renderAll(); scheduleSave(); }
  });
  deleteZone.addEventListener('click', () => {
    if (selectedId) { containers = containers.filter(c => c.id != selectedId); selectedId = null; document.getElementById('infoSelected').textContent = ''; renderAll(); scheduleSave(); }
  });
 
  // Keyboard
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedId && !['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) {
      containers = containers.filter(c => c.id != selectedId);
      selectedId = null; document.getElementById('infoSelected').textContent = '';
      renderAll(); scheduleSave();
    }
    if ((e.key === 'r' || e.key === 'R') && selectedId && !['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) {
      const c = containers.find(x => x.id == selectedId);
      if (c) {
        const newOrient = c.orient === 'H' ? 'V' : 'H';
        const cs = containerSize(c.type, newOrient);
        if (canPlace(c.col, c.row, cs.w, cs.h, c.id)) { c.orient = newOrient; renderAll(); selectContainer(selectedId); scheduleSave(); }
      }
    }
  });
 
  // Modal
  window.openModal = () => { document.getElementById('modalOverlay').classList.add('show'); document.getElementById('modalLabel').value = ''; document.getElementById('modalLabel').focus(); };
  window.closeModal = () => document.getElementById('modalOverlay').classList.remove('show');
 
  window.addFromModal = () => {
    const type = document.getElementById('modalSize').value;
    const label = document.getElementById('modalLabel').value.trim() || null;
    const orient = document.getElementById('modalOrient').value;
    const cs = containerSize(type, orient);
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        if (canPlace(c, r, cs.w, cs.h)) { addContainer(type, c, r, orient, selectedColor, label); closeModal(); return; }
      }
    }
    alert('No hay espacio disponible.');
  };
 
  document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
  document.getElementById('modalLabel').addEventListener('keydown', (e) => { if (e.key === 'Enter') addFromModal(); if (e.key === 'Escape') closeModal(); });
 
  window.clearAll = () => {
    if (confirm('¬øEliminar todos los contenedores?')) { containers = []; selectedId = null; document.getElementById('infoSelected').textContent = ''; renderAll(); scheduleSave(); }
  };
 
  window.setOrientation = (o) => {
    orientation = o;
    document.querySelectorAll('.orient-btn').forEach(b => b.classList.toggle('active', b.dataset.orient === o));
  };
 
  window.setColor = (el) => {
    selectedColor = el.dataset.color;
    document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('active', d === el));
  };
 
  // Init
  buildGrid();
</script>
</body>
</html>
 
